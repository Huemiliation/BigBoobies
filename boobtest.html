<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Memories</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { script: ['"Great Vibes"', 'cursive'], sans: ['"Montserrat"', 'sans-serif'] },
                    colors: { glass: "rgba(255, 255, 255, 0.05)" },
                    animation: { 'scroll': 'scroll 60s linear infinite' },
                    keyframes: { scroll: { '0%': { transform: 'translateX(0)' }, '100%': { transform: 'translateX(-33.33%)' } } }
                }
            }
        }
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { overflow-x: hidden; background-color: #000; transition: background 1.5s ease-in-out; touch-action: pan-y; }
        
        /* --- LOADER --- */
        #initial-loader {
            position: fixed; inset: 0; z-index: 9999; background: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease, visibility 0.8s;
        }
        .loader-wrapper { animation: spin 8s linear infinite; }
        .loader-heart {
            width: 60px; height: 60px; background: #e11d48; 
            position: relative; transform: rotate(45deg);
            box-shadow: 0 0 30px #e11d48;
            animation: heartBeatMain 1.2s infinite;
        }
        .loader-heart::before, .loader-heart::after {
            content: ""; position: absolute; width: 60px; height: 60px; 
            border-radius: 50%; background: #e11d48;
            box-shadow: 0 0 30px #e11d48;
        }
        .loader-heart::before { left: -30px; } .loader-heart::after { top: -30px; }
        @keyframes heartBeatMain {
            0% { transform: rotate(45deg) scale(0.8); opacity: 0.8; }
            10% { transform: rotate(45deg) scale(1.1); opacity: 1; box-shadow: 0 0 50px #e11d48; }
            20% { transform: rotate(45deg) scale(0.9); opacity: 0.9; }
            30% { transform: rotate(45deg) scale(1.2); opacity: 1; box-shadow: 0 0 60px #e11d48; }
            50% { transform: rotate(45deg) scale(0.8); opacity: 0.8; }
            100% { transform: rotate(45deg) scale(0.8); opacity: 0.8; }
        }
        .loading-bar { display: flex; gap: 8px; margin-top: 40px; }
        .mini-heart { color: #e11d48; font-size: 16px; animation: miniFade 1.5s infinite; opacity: 0.2; }
        .mini-heart:nth-child(1) { animation-delay: 0.0s; } .mini-heart:nth-child(2) { animation-delay: 0.2s; }
        .mini-heart:nth-child(3) { animation-delay: 0.4s; } .mini-heart:nth-child(4) { animation-delay: 0.6s; }
        .mini-heart:nth-child(5) { animation-delay: 0.8s; }
        @keyframes miniFade { 0%, 100% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); text-shadow: 0 0 10px #e11d48; } }

        /* --- STYLES --- */
        .liquid-glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4); }
        .special-border { position: relative; background: rgba(20, 10, 5, 0.4); backdrop-filter: blur(16px); border: 1px solid rgba(255, 215, 0, 0.3); box-shadow: 0 0 30px rgba(255, 215, 0, 0.1); }
        .gold-text { background: linear-gradient(to right, #fcd34d, #f59e0b, #fff, #f59e0b); background-size: 200% auto; color: transparent; -webkit-background-clip: text; background-clip: text; animation: shine 4s linear infinite; }
        @keyframes shine { to { background-position: 200% center; } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #stars { position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: 0.6; }
        #particle-container { position: fixed; inset: 0; pointer-events: none; z-index: 1; }
        .heart-particle { position: absolute; opacity: 0; }
        
        /* --- MUSIC PLAYER RANGE SLIDER (HEART THUMB) --- */
        .music-slider { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px; background: transparent; outline: none; cursor: pointer; }
        .music-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background-color: #fff;
            clip-path: path("M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z");
            margin-top: -9px; transition: transform 0.1s ease; box-shadow: 0 0 10px rgba(255,255,255,0.9);
        }
        .music-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .music-slider::-moz-range-thumb {
            width: 24px; height: 24px; background-color: #fff;
            clip-path: path("M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z");
            border: none;
        }

        .cursor-zoom-in { cursor: zoom-in; }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
    </style>
</head>
<body>

    <div id="initial-loader">
        <div class="loader-wrapper"><div class="loader-heart"></div></div>
        <div class="loading-bar">
            <div class="mini-heart">❤</div><div class="mini-heart">❤</div><div class="mini-heart">❤</div><div class="mini-heart">❤</div><div class="mini-heart">❤</div>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, AnimatePresence, useInView } = window.Motion;

        // ==========================================
        //  CONFIG
        // ==========================================
        const BASE_URL = "https://huemiliation.github.io/BigBoobies/memories/";

        const NOTES_2023 = {
            beninging: {},
            whereItAllStarted: {},
            inThePark: {},
            onTheBridge: {},
            tastyFood: {},
            wattesigma: {},
            baklava: {},
            cafeKetab: {},
            doretBegardam: {},
            rambod: {},
            jerKhordim: {},
            nose: {},
            vijioCawl: {}
        };

        const SHIRAZ_NOTES = {
            1: "The moment we arrived in Shiraz.",
            2: "Looking at you here, I felt so lucky.",
            12: "The architecture was stunning.",
            36: "I didn't want this trip to end.",
        };

        // --- MEDIA LOADER ---
        const getMedia = (path, count, notesMap = {}, videoIndices = [], defaultNote = "") => {
            const safePath = path.split('/').map(part => encodeURIComponent(part)).join('/');
            
            return Array.from({ length: count }, (_, i) => {
                const num = i + 1;
                const isVideo = videoIndices.includes(num);
                // Video thumbnail trick: #t=0.001
                const fileName = `${num}.${isVideo ? 'mp4#t=0.001' : 'webp'}`;
                
                return {
                    id: `${path}-${num}`,
                    src: `${BASE_URL}${safePath}/${fileName}`,
                    type: isVideo ? 'video' : 'image',
                    note: notesMap[num] || defaultNote
                };
            });
        };

        const generatePlaceholders = (seed, context, count = 5) => {
            return Array.from({ length: count }, (_, i) => ({
                id: `${seed}-${i}`,
                src: `https://picsum.photos/seed/${seed * (i + 1)}/600/800`,
                type: 'image',
                note: `Memory #${i + 1} from ${context}.`
            }));
        };

        const CHAPTERS = [
            // ================= CHAPTER ONE (2023) =================
            {
                id: 1,
                title: "Chapter One",
                subtitle: "Test Drive",
                theme: { from: "#0f172a", to: "#172554", accent: "#38bdf8" }, 
                song: { title: "Separator", url: "https://huemiliation.github.io/BigBoobies/08%20Radiohead%20-%20Separator.mp3" },
                albums: [
                    { title: "In The Beninging", month: "FEB - JUNE", photos: getMedia("2023/february - june/in the beninging", 11, NOTES_2023.beninging, [2,3,4,7,8,9,10]) },
                    { title: "Where It All Started", month: "OCTOBER", photos: getMedia("2023/october/where it all started", 11, NOTES_2023.whereItAllStarted, [1,3]) },
                    { title: "In The Park", month: "NOVEMBER", photos: getMedia("2023/november/in the park", 9, NOTES_2023.inThePark, []) },
                    { title: "On The Bridge", month: "NOVEMBER", photos: getMedia("2023/november/on the bridge", 17, NOTES_2023.onTheBridge, []) },
                    { title: "Tasty Food", month: "NOVEMBER", photos: getMedia("2023/november/tasty foooooood", 7, NOTES_2023.tastyFood, []) },
                    { title: "Wattesigma", month: "NOVEMBER", photos: getMedia("2023/november/wattesigma", 4, NOTES_2023.wattesigma, []) },
                    { title: "Baklava Cookie", month: "DECEMBER", photos: getMedia("2023/december/baklava cookie", 10, NOTES_2023.baklava, []) },
                    { title: "Cafe Ketab", month: "DECEMBER", photos: getMedia("2023/december/cafe ketab", 8, NOTES_2023.cafeKetab, []) },
                    { title: "Doret Begardam", month: "DECEMBER", photos: getMedia("2023/december/doret begardam", 6, NOTES_2023.doretBegardam, [5,6]) },
                    { title: "Fun With Rambod", month: "DECEMBER", photos: getMedia("2023/december/fun with rambod", 5, NOTES_2023.rambod, []) },
                    { title: "Jer Khordim", month: "DECEMBER", photos: getMedia("2023/december/jer khordim", 4, NOTES_2023.jerKhordim, []) },
                    { title: "Nose", month: "DECEMBER", photos: getMedia("2023/december/nose", 28, NOTES_2023.nose, []) },
                    { title: "Vijio Cawl", month: "DECEMBER", photos: getMedia("2023/december/vijio cawl", 4, NOTES_2023.vijioCawl, []) },
                ]
            },
            
            // ================= CHAPTER TWO (Shiraz & 2025) =================
            {
                id: 2,
                title: "Chapter Two",
                subtitle: "Golden Hour",
                theme: { from: "#1c1006", to: "#3a1d08", accent: "#fbbf24" }, 
                song: { title: "Weird Fishes", url: "https://huemiliation.github.io/BigBoobies/04%20Radiohead%20-%20Weird%20Fishes_%20Arpeggi.mp3" },
                albums: [
                    { 
                        title: "Shiraz: The Best Trip", 
                        month: "JANUARY 2025", 
                        isSpecial: true, 
                        photos: getMedia("2025/january/shiraz", 36, SHIRAZ_NOTES, [2, 5], "A beautiful moment from Shiraz.") 
                    },
                    { title: "Milad Moments", month: "JANUARY 2025", photos: getMedia("2025/january/milad", 12, {}, [], "Fun times at Milad.") },
                    { title: "Snowy Days", month: "JANUARY 2025", photos: getMedia("2025/january/snow", 9, {}, [], "Playing around in the snow!") },
                    { title: "Just Us", month: "JANUARY 2025", photos: getMedia("2025/january/other", 2, {}, [], "Cute little moments.") },
                    { title: "Future Memories", month: "FOREVER", photos: generatePlaceholders(305, "The Future") }
                ]
            }
        ];

        // ==========================================
        //  COMPONENTS
        // ==========================================

        const ParticleSystem = ({ activeChapter }) => {
            useEffect(() => {
                const container = document.getElementById('particle-container');
                let colors = ['#ffffff'];
                let spawnRate = 1500;
                if(activeChapter === 1) { colors = ['#fbbf24', '#ffffff']; spawnRate = 800; }
                if(activeChapter === 2) { colors = ['#f43f5e', '#ff00ff']; spawnRate = 400; }
                const interval = setInterval(() => {
                    if (document.hidden) return;
                    const h = document.createElement('div');
                    h.innerHTML = '❤';
                    h.className = 'heart-particle';
                    h.style.left = Math.random() * 100 + 'vw';
                    h.style.bottom = '-50px';
                    h.style.fontSize = (Math.random() * 20 + 10) + 'px';
                    h.style.color = colors[Math.floor(Math.random() * colors.length)];
                    h.style.textShadow = activeChapter === 2 ? `0 0 10px ${h.style.color}` : 'none';
                    h.animate([
                        { transform: 'translateY(0) rotate(0deg)', opacity: 0 },
                        { opacity: 0.8, offset: 0.1 },
                        { transform: `translateY(-100vh) rotate(${Math.random()*360}deg)`, opacity: 0 }
                    ], { duration: 5000 + Math.random() * 5000, easing: 'linear' }).onfinish = () => h.remove();
                    container.appendChild(h);
                }, spawnRate);
                return () => clearInterval(interval);
            }, [activeChapter]);
            return null;
        };

        const ScrollRevealer = ({ text, accent }) => {
            const ref = useRef(null);
            const isInView = useInView(ref, { once: true, amount: 0.5 });
            const [display, setDisplay] = useState("");
            useEffect(() => {
                if (isInView) {
                    const totalDuration = 1200; 
                    const charDelay = Math.max(100, totalDuration / text.length); 
                    let i = 0;
                    const t = setInterval(() => {
                        if (i < text.length) { setDisplay(prev => prev + text.charAt(i)); i++; } else clearInterval(t);
                    }, charDelay);
                    return () => clearInterval(t);
                }
            }, [isInView, text]);
            return (
                <div ref={ref} className="font-sans font-black text-2xl md:text-4xl tracking-widest uppercase opacity-90 min-h-[40px] px-2" style={{ color: accent }}>
                    {display}{isInView && display.length < text.length && <span className="animate-pulse">|</span>}
                </div>
            );
        };

        const Typewriter = ({ text, speed = 50 }) => {
            const [disp, setDisp] = useState("");
            useEffect(() => {
                setDisp("");
                let i = 0;
                const t = setInterval(() => {
                    if(i < (text || "").length) { setDisp(p => p + text.charAt(i)); i++; } else clearInterval(t);
                }, speed);
                return () => clearInterval(t);
            }, [text, speed]);
            return <span>{disp}</span>;
        };

        const MusicController = ({ song, accent, activeSong, onToggle, audioRef }) => {
            const isActive = activeSong === song.url;
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);

            useEffect(() => {
                if (isActive && audioRef.current) {
                    const aud = audioRef.current;
                    const update = () => { setCurrentTime(aud.currentTime); setDuration(aud.duration || 0); };
                    aud.addEventListener('timeupdate', update);
                    return () => aud.removeEventListener('timeupdate', update);
                }
            }, [isActive, audioRef]);

            const handleSeek = (e) => {
                if(audioRef.current) {
                    const val = Number(e.target.value);
                    audioRef.current.currentTime = val;
                    setCurrentTime(val);
                }
            };

            const fmt = (t) => {
                if(!t) return "0:00";
                const m = Math.floor(t / 60);
                const s = Math.floor(t % 60);
                return `${m}:${s<10?'0':''}${s}`;
            };

            const progressPercent = duration ? (currentTime / duration) * 100 : 0;

            return (
                <div className="flex justify-center my-6 h-14 z-30 relative">
                    <motion.div 
                        layout initial={false} transition={{ type: "spring", stiffness: 400, damping: 30 }}
                        className={`relative rounded-full flex items-center overflow-hidden backdrop-blur-md`}
                        style={{ backgroundColor: isActive ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.05)', borderColor: accent, borderWidth: isActive ? '1px' : '2px' }}
                        animate={!isActive ? { boxShadow: `0 0 15px ${accent}`, scale: [1, 1.05, 1], cursor: 'pointer' } : { boxShadow: 'none', scale: 1, cursor: 'default' }}
                        onClick={() => !isActive && onToggle(song.url)}
                    >
                        <AnimatePresence mode="wait">
                            {!isActive ? (
                                <motion.div key="play" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="flex items-center justify-center px-8 py-2 gap-3 min-w-[180px]">
                                    <span className="text-xl text-white drop-shadow-md">▶</span>
                                    <span className="text-xs font-bold uppercase tracking-widest text-white whitespace-nowrap drop-shadow-md">{song.title}</span>
                                </motion.div>
                            ) : (
                                <motion.div key="controls" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="px-5 py-2 flex items-center gap-3 min-w-[300px]">
                                    <button onClick={(e) => { e.stopPropagation(); onToggle(song.url); }} className="hover:scale-110 active:scale-95 transition-transform"><span className="text-lg" style={{color: accent}}>⏸</span></button>
                                    <div className="flex-1 flex flex-col gap-1 w-full">
                                        <div className="flex justify-between items-end text-[9px] font-mono text-gray-400 w-full">
                                            <span>{fmt(currentTime)}</span>
                                            <span className="font-bold uppercase tracking-wider text-white mx-2 truncate">{song.title}</span>
                                            <span>{fmt(duration)}</span>
                                        </div>
                                        <input 
                                            type="range" min="0" max={duration || 100} value={currentTime} onChange={handleSeek}
                                            onMouseDown={(e) => e.stopPropagation()} onTouchStart={(e) => e.stopPropagation()}
                                            className="music-slider"
                                            style={{ background: `linear-gradient(to right, ${accent} 0%, ${accent} ${progressPercent}%, rgba(255,255,255,0.1) ${progressPercent}%, rgba(255,255,255,0.1) 100%)` }}
                                        />
                                    </div>
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </motion.div>
                </div>
            );
        };

        const Carousel = ({ photos, onOpen, isSpecial, onLoad }) => {
            const speed = Math.max(40, photos.length * 3) + 's';
            // Repeat photos 3 times for infinite scroll illusion
            const displayPhotos = useMemo(() => [...photos, ...photos, ...photos], [photos]);

            return (
                <div className="w-full overflow-hidden relative py-6 group">
                    <div className="absolute left-0 top-0 bottom-0 w-8 z-10 bg-gradient-to-r from-black/50 to-transparent pointer-events-none"></div>
                    <div className="absolute right-0 top-0 bottom-0 w-8 z-10 bg-gradient-to-l from-black/50 to-transparent pointer-events-none"></div>
                    <div className="flex w-max gap-4 md:gap-6 animate-scroll hover:[animation-play-state:paused]" style={{ animationDuration: speed }}>
                        {displayPhotos.map((photo, idx) => (
                            <div
                                key={`${photo.id}-${idx}`}
                                className={`relative flex-shrink-0 rounded-xl overflow-hidden cursor-pointer border transition-transform duration-300 hover:scale-105 ${isSpecial ? 'w-[180px] h-[260px] border-amber-400 shadow-[0_0_15px_rgba(251,191,36,0.5)]' : 'w-[140px] h-[200px] border-white/10'}`}
                                onClick={() => onOpen(idx % photos.length)}
                            >
                                {photo.type === 'video' ? (
                                    <div className="w-full h-full relative">
                                        {/* Added #t=0.001 to src for thumbnail preview */}
                                        <video 
                                            src={photo.src} 
                                            className="w-full h-full object-cover pointer-events-none" 
                                            muted preload="metadata" 
                                            onLoadedData={onLoad} // Trigger load count for loader
                                        />
                                        <div className="absolute inset-0 flex items-center justify-center bg-black/40">
                                            <div className="w-10 h-10 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center border border-white/50"><span className="ml-1 text-white">▶</span></div>
                                        </div>
                                    </div>
                                ) : (
                                    <img 
                                        src={photo.src} alt="memory" loading="lazy" 
                                        className="w-full h-full object-cover" 
                                        onError={(e) => e.target.src = 'https://picsum.photos/200/300'} 
                                        onLoad={onLoad} // Trigger load count for loader
                                    />
                                )}
                                <div className="absolute inset-0 bg-black/10 hover:bg-transparent transition-colors"></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const HeartIcon = ({ rotate, color }) => (
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style={{ transform: `rotate(${rotate}deg)`, color: color }}>
                 <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
        );

        const ZoomableMedia = ({ media, accent, onRequestPauseMusic }) => {
            const [scale, setScale] = useState(1);
            const [position, setPosition] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const containerRef = useRef(null);
            const startPos = useRef({ x: 0, y: 0 });
            const startTranslate = useRef({ x: 0, y: 0 });
            const lastDistance = useRef(null);

            useEffect(() => { setScale(1); setPosition({ x: 0, y: 0 }); }, [media.src]);
            const limitScale = (s) => Math.min(Math.max(1, s), 5);
            const getDistance = (touches) => Math.hypot(touches[0].pageX - touches[1].pageX, touches[0].pageY - touches[1].pageY);

            // --- FIXED PC ZOOM ---
            const handleWheel = (e) => {
                // Prevent Default to stop page scrolling while zooming image
                if(e.ctrlKey || Math.abs(e.deltaY) > 0) {
                     e.preventDefault(); 
                }

                if (Math.abs(e.deltaY) > 0) {
                    const delta = -e.deltaY * 0.003; // Adjusted sensitivity
                    const newScale = limitScale(scale + delta);
                    setScale(newScale);
                    if (newScale === 1) setPosition({ x: 0, y: 0 });
                    // Explicitly stop propagation to be safe
                    e.stopPropagation();
                }
            };

            const handleMouseDown = (e) => { if (scale > 1) { setIsDragging(true); startPos.current = { x: e.clientX, y: e.clientY }; startTranslate.current = { ...position }; } };
            const handleMouseMove = (e) => { if (isDragging && scale > 1) { e.preventDefault(); const dx = e.clientX - startPos.current.x; const dy = e.clientY - startPos.current.y; setPosition({ x: startTranslate.current.x + dx, y: startTranslate.current.y + dy }); } };
            const handleMouseUp = () => setIsDragging(false);
            const handleTouchStart = (e) => {
                if (e.touches.length === 2) { lastDistance.current = getDistance(e.touches); }
                else if (e.touches.length === 1 && scale > 1) { setIsDragging(true); startPos.current = { x: e.touches[0].pageX, y: e.touches[0].pageY }; startTranslate.current = { ...position }; }
            };
            const handleTouchMove = (e) => {
                if (e.touches.length === 2 && lastDistance.current) {
                    const dist = getDistance(e.touches); const delta = dist / lastDistance.current; const newScale = limitScale(scale * delta); lastDistance.current = dist; setScale(newScale); if (newScale === 1) setPosition({x:0, y:0}); e.preventDefault(); 
                } else if (e.touches.length === 1 && isDragging) {
                    const dx = e.touches[0].pageX - startPos.current.x; const dy = e.touches[0].pageY - startPos.current.y; setPosition({ x: startTranslate.current.x + dx, y: startTranslate.current.y + dy });
                }
            };
            const handleTouchEnd = () => { setIsDragging(false); lastDistance.current = null; };
            const zoomIn = () => setScale(s => limitScale(s + 0.5));
            const zoomOut = () => { const s = limitScale(scale - 0.5); setScale(s); if(s===1) setPosition({x:0, y:0}); };
            const reset = () => { setScale(1); setPosition({x:0, y:0}); };

            return (
                <div 
                    className="relative w-full h-full flex items-center justify-center overflow-hidden" ref={containerRef}
                    onWheel={handleWheel} onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp} onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}
                >
                    <motion.div
                        className={`relative flex items-center justify-center ${scale > 1 ? (isDragging ? 'cursor-grabbing' : 'cursor-grab') : 'cursor-zoom-in'}`}
                        initial={{ opacity: 0, scale: 0.8 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, scale: 1.1, transition: { duration: 0.15 } }}
                        transition={{ type: "spring", stiffness: 300, damping: 25 }}
                        style={{ transform: `translate3d(${position.x}px, ${position.y}px, 0) scale(${scale})`, transition: isDragging ? 'none' : 'transform 0.2s cubic-bezier(0.1, 0.67, 0.29, 0.98)', transformOrigin: 'center', touchAction: 'none' }}
                        onDoubleClick={() => { if (scale > 1) { setScale(1); setPosition({ x: 0, y: 0 }); } else { setScale(2.5); } }}
                    >
                         {media.type === 'video' ? (
                             <video src={media.src} draggable={false} onDragStart={e=>e.preventDefault()} controls playsInline className="max-w-full max-h-[65vh] rounded-lg shadow-2xl" style={{ boxShadow: `0 0 40px ${accent}20` }} onPlay={onRequestPauseMusic} />
                         ) : (
                             <img src={media.src} alt="Memory" draggable={false} onDragStart={e=>e.preventDefault()} className="max-w-full max-h-[65vh] object-contain rounded-lg shadow-2xl select-none" style={{ boxShadow: `0 0 40px ${accent}20` }} />
                         )}
                    </motion.div>
                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-4 bg-black/60 backdrop-blur-md px-4 py-2 rounded-full border border-white/10 shadow-lg z-50" onClick={e => e.stopPropagation()}>
                         <button onClick={zoomOut} className="text-white hover:text-amber-400 font-bold text-xl px-2 active:scale-90 transition">-</button>
                         <button onClick={reset} className="text-xs uppercase tracking-widest text-white/70 hover:text-white pt-1">Reset</button>
                         <button onClick={zoomIn} className="text-white hover:text-amber-400 font-bold text-xl px-2 active:scale-90 transition">+</button>
                    </div>
                </div>
            );
        };

        const Lightbox = ({ isOpen, albumPhotos, startIndex, onClose, accent, onPauseMusic }) => {
            if (!isOpen || !albumPhotos) return null;
            const [idx, setIdx] = useState(startIndex);
            const photo = albumPhotos[idx];
            const navigate = (dir) => setIdx((prev) => (prev + dir + albumPhotos.length) % albumPhotos.length);

            useEffect(() => { document.body.style.overflow = 'hidden'; return () => document.body.style.overflow = ''; }, []);

            return (
                <motion.div 
                    initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
                    className="fixed inset-0 z-[100] flex items-center justify-center bg-black/95 backdrop-blur-xl p-4"
                    onClick={onClose}
                >
                    <button onClick={onClose} className="absolute top-4 right-4 p-3 bg-white/10 rounded-full hover:bg-white/20 z-[110]"><svg width="24" height="24" viewBox="0 0 24 24" stroke="white" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    <button onClick={(e) => { e.stopPropagation(); navigate(-1); }} className="absolute left-2 md:left-8 top-1/2 -translate-y-1/2 z-[105] p-2 transition-transform active:scale-75 hover:scale-110 cursor-pointer"><HeartIcon rotate={-90} color={accent} /></button>
                    <button onClick={(e) => { e.stopPropagation(); navigate(1); }} className="absolute right-2 md:right-8 top-1/2 -translate-y-1/2 z-[105] p-2 transition-transform active:scale-75 hover:scale-110 cursor-pointer"><HeartIcon rotate={90} color={accent} /></button>

                    <div className="flex flex-col items-center gap-4 w-full max-w-4xl h-full justify-center" onClick={e => e.stopPropagation()}>
                        <div className="relative flex-1 w-full flex items-center justify-center overflow-hidden">
                           <AnimatePresence mode="wait">
                               <ZoomableMedia key={photo.src} media={photo} accent={accent} onRequestPauseMusic={onPauseMusic} />
                           </AnimatePresence>
                        </div>
                        <div className="w-full max-w-lg flex-shrink-0 relative z-[60]">
                            <div className="liquid-glass rounded-xl p-4 w-full overflow-x-auto hide-scrollbar border-l-4 mb-2 min-h-[80px] flex items-center" style={{ borderColor: accent }}>
                                <p className="text-gray-200 font-sans text-sm md:text-base font-light tracking-wide whitespace-nowrap pr-8"><Typewriter text={photo.note} speed={50} /></p>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="text-[10px] font-mono text-gray-400">{idx + 1}</span>
                                <div className="flex-1 h-1 bg-white/10 rounded-full overflow-hidden"><motion.div className="h-full" style={{ backgroundColor: accent }} animate={{ width: `${((idx + 1) / albumPhotos.length) * 100}%` }} /></div>
                                <span className="text-[10px] font-mono text-gray-400">{albumPhotos.length}</span>
                            </div>
                        </div>
                    </div>
                </motion.div>
            );
        };

        const App = () => {
            const [activeChapter, setActiveChapter] = useState(0);
            const [lightbox, setLightbox] = useState({ open: false, photos: [], index: 0 });
            const [activeSong, setActiveSong] = useState(null);
            const audioRef = useRef(null);
            const [loadedImages, setLoadedImages] = useState(0);

            // --- SMART LOADER LOGIC ---
            // Remove loader if 5 images loaded OR 5 seconds passed
            useEffect(() => {
                const loader = document.getElementById('initial-loader');
                if (!loader) return;

                const removeLoader = () => {
                    loader.style.opacity = '0';
                    loader.style.visibility = 'hidden';
                    setTimeout(() => loader.remove(), 800);
                };

                const timeout = setTimeout(removeLoader, 5000); // 5s safety net

                if (loadedImages > 5) {
                    clearTimeout(timeout);
                    removeLoader();
                }

                return () => clearTimeout(timeout);
            }, [loadedImages]);

            useEffect(() => {
                const onScroll = () => { document.querySelectorAll('.chapter-section').forEach((sec, i) => { const r = sec.getBoundingClientRect(); if (r.top <= window.innerHeight * 0.6 && r.bottom >= window.innerHeight * 0.4) setActiveChapter(i); }); };
                window.addEventListener('scroll', onScroll); return () => window.removeEventListener('scroll', onScroll);
            }, []);

            useEffect(() => {
                const aud = audioRef.current;
                if(!aud) return;
                const onEnd = () => setActiveSong(null);
                aud.addEventListener('ended', onEnd);
                if(activeSong) { aud.src = activeSong; aud.play().catch(e => console.log(e)); }
                else aud.pause();
                return () => { aud.pause(); aud.removeEventListener('ended', onEnd); }
            }, [activeSong]);

            const theme = CHAPTERS[activeChapter].theme;

            return (
                <div className="min-h-screen transition-colors duration-[2000ms]" style={{ background: `linear-gradient(to bottom, ${theme.from}, ${theme.to})` }}>
                    <div id="stars"></div>
                    <div id="particle-container"></div>
                    <ParticleSystem activeChapter={activeChapter} />
                    <audio ref={audioRef} />

                    <div className="relative z-10 max-w-6xl mx-auto px-4 pb-32">
                        <header className="pt-32 pb-20 text-center animate-fade-in-up">
                            <h1 className="font-script text-7xl md:text-9xl text-white mb-4 drop-shadow-xl">Our Memories</h1>
                        </header>

                        {CHAPTERS.map((chapter) => (
                            <section key={chapter.id} className="chapter-section py-24 min-h-[85vh]">
                                <div className="text-center mb-16">
                                    <h2 className="font-script text-6xl text-white/90 mb-2">{chapter.title}</h2>
                                    <h3 className="font-sans text-sm tracking-[0.4em] uppercase opacity-70" style={{ color: theme.accent }}>{chapter.subtitle}</h3>
                                    <MusicController song={chapter.song} accent={theme.accent} activeSong={activeSong} audioRef={audioRef} onToggle={(url) => setActiveSong(activeSong === url ? null : url)} />
                                </div>
                                <div className="space-y-16">
                                    {chapter.albums.map((album, idx) => {
                                        const showMonth = idx === 0 || album.month !== (idx > 0 ? chapter.albums[idx-1].month : '');
                                        return (
                                            <div key={idx}>
                                                {showMonth && (
                                                    <div className="mb-8 mt-12 flex items-center gap-4">
                                                        <div className="h-[1px] flex-1 bg-gradient-to-r from-transparent to-white/20"></div>
                                                        <ScrollRevealer text={album.month} accent={theme.accent} />
                                                        <div className="h-[1px] flex-1 bg-gradient-to-l from-transparent to-white/20"></div>
                                                    </div>
                                                )}
                                                <div className={`rounded-3xl p-6 transition-all duration-500 ${album.isSpecial ? 'special-border' : 'liquid-glass hover:bg-white/5'}`}>
                                                    <div className="flex items-center gap-3 mb-4">
                                                        <h4 className={`font-sans font-bold text-lg ml-2 ${album.isSpecial ? 'gold-text text-xl' : 'text-white'}`}>{album.title}</h4>
                                                        {album.isSpecial && <div className="bg-amber-500/20 border border-amber-400/50 text-amber-300 text-[10px] font-bold px-2 py-0.5 rounded shadow-[0_0_10px_rgba(251,191,36,0.5)] animate-pulse">SPECIAL</div>}
                                                    </div>
                                                    <Carousel 
                                                        photos={album.photos} 
                                                        isSpecial={album.isSpecial} 
                                                        onOpen={(i) => setLightbox({ open: true, photos: album.photos, index: i })}
                                                        // Pass loader trigger to first album only
                                                        onLoad={() => idx === 0 && setLoadedImages(p => p + 1)}
                                                    />
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </section>
                        ))}
                    </div>

                    <AnimatePresence>
                        {lightbox.open && (
                            <Lightbox isOpen={lightbox.open} albumPhotos={lightbox.photos} startIndex={lightbox.index} onClose={() => setLightbox({ ...lightbox, open: false })} accent={theme.accent} onPauseMusic={() => setActiveSong(null)} />
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-33.33%); } }
            .animate-scroll { animation: scroll 80s linear infinite; }
            .animate-fade-in-up { animation: fadeInUp 1.2s ease-out forwards; }
            @keyframes fadeInUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
            #stars { background-image: radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)), radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)), radial-gradient(2px 2px at 50px 160px, #ddd, rgba(0,0,0,0)); background-size: 200px 200px; animation: zoom 100s infinite; }
            @keyframes zoom { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        `;
        document.head.appendChild(styleSheet);

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
